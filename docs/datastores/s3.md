AWS S3 uses the AWS IAM authorization system to manage access to S3 buckets.
AWS IAM implements both role-based and attribute-based (session tags) control approaches.

AWS IAM lets you set allow or deny policies for a AWS Principal.
Taking into account the AWS policy evaluation processing (which simulates by the authz-analyzer),
the final allowed policies grant access for a principal to an S3 bucket.

There are several types of AWS Principal IAM users, IAM role, Federated user, AWS Service, or an anonymous principal.
An AWS Principal has a set of permissions in specific policies, such as identity-based policies that perform actions. For example, creating an object in an S3 bucket. 

An AWS IAM role is defined by a trusted relationship policy in which principals are allowed from the same account or other accounts (such as cross-account access) to assume this role and act as this role principal.

In addition to policies defined on an AWS principal, the S3 bucket may also have a resource-based policy.
This policy can grant access directly to an AWS Principal.

**Authz. Analyzer** analyzes all possible paths between an AWS principal and the S3 bucket.
It stimulates the AWS policy evaluation process, taking into account the allow/deny policies attached to the principal or S3 bucket, 
validates the chain of the assuming roles in a path, and exposes the final allowed possible paths between the AWS principal to S3 bucket

## Analyze AWS S3 Buckets
Authz-analyzer connects to AWS accounts and scans them.

The following section desibes the parameters that the authz-analyzer requires:

#### Target Account
Authz-analyzer scans the s3 buckets from a single AWS account. We refer to this account as the **target account**.

#### Additional Accounts
In addition to the target account, authz-analyzer lets you provide additional accounts.
AWS allows cross-account access. Hence the principal from **account X** can gain access to the S3 bucket on the target account. 
To let the authz-analyzer resolve the principals between those accounts, you can provide additional AWS accounts.

>Note: **authz-analyzer** will not scan the s3 buckets on the additional accounts, only the buckets that belong to the target account.

#### Role Name
Authz-analyzer uses the IAM role to connect to the target/additional AWS account.
It assumes that a predefined IAM role with the relevant permissions to let the authz-analyzer get the required information has beed created.
You should create a role of this type for every relevant AWS account.  You must use the same role name between all of the accounts.

#### External ID
In AWS cross-account access, it is a best practice to use **external-ID** when assuming AWS role.
This solves the "confused deputy" security issue.


### Setup Access to Scan an AWS Account

To enable authz-analyzer to scan the IAM principals to S3 buckets permissions, perform the following steps:
1. For each AWS account, create a role to be assumed by the authz-analyzer (should be the same name on all accounts)
2. Attached the following policy to the new role
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "SatoriAnalyzer",
            "Effect": "Allow",
            "Action": [
                "iam:List*",
                "iam:Get*",
                "s3:ListAccessPointsForObjectLambda",
                "s3:GetAccessPoint",
                "s3:GetLifecycleConfiguration",
                "s3:GetBucketTagging",
                "s3:GetAccessPointPolicyForObjectLambda",
                "s3:ListBucketVersions",
                "s3:ListBucket",
                "s3:GetObjectVersionAttributes",
                "s3:GetBucketPolicy",
                "s3:GetObjectAcl",
                "s3:GetBucketObjectLockConfiguration",
                "s3:GetAccessPointPolicyStatus",
                "s3:GetObjectVersionAcl",
                "s3:GetObjectTagging",
                "s3:GetBucketOwnershipControls",
                "s3:GetBucketPublicAccessBlock",
                "s3:GetMultiRegionAccessPointPolicyStatus",
                "s3:GetBucketPolicyStatus",
                "s3:GetObjectRetention",
                "s3:GetMultiRegionAccessPointPolicy",
                "s3:GetBucketWebsite",
                "s3:GetAccessPointPolicyStatusForObjectLambda",
                "s3:ListAccessPoints",
                "s3:GetMultiRegionAccessPoint",
                "s3:GetObjectAttributes",
                "s3:ListMultiRegionAccessPoints",
                "s3:GetBucketVersioning",
                "s3:GetBucketAcl",
                "s3:GetObjectLegalHold",
                "s3:GetAccessPointConfigurationForObjectLambda",
                "s3:DescribeMultiRegionAccessPointOperation",
                "s3:GetObject",
                "s3:GetAccountPublicAccessBlock",
                "s3:ListAllMyBuckets",
                "s3:GetBucketCORS",
                "s3:GetBucketLocation",
                "s3:GetAccessPointPolicy",
                "s3:GetObjectVersion"
            ],
            "Resource": "*"
        }
    ]
}
```
3. Add the following statement to the roleâ€™s Trust Relationships
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Statement1",
            "Effect": "Allow",
            "Principal": {
                "AWS": [
                    "<ARN-TRUSTED-PRINCIPAL>"
                ]
            },
            "Action": "sts:AssumeRole"
            "Condition": {
                "StringEquals": {
                    "sts:ExternalId": <EXTERNAL-ID>
                }
            }
        }
    ]
}
```
The ARN-TRUSTED-PRINCIPAL is the AWS ARN of the authenticated principal which running the authz-analyzer.

### Scanning an AWS 
```
authz-analyzer aws-s3 \
    --target-account-id <AWS target account id> \
    --additional-account-id <AWS additional account id> \
    --role-name <ROLE-NAME>
    --external-id <EXTERNAL-ID>
```
The --additional-account-id is multiple optional parameter, which means you may mention it zero or more times in order to add multiple AWS additional account ids

## Known Limitations
The following AWS features are not currently supported by authz-analyzer:

* Policy evaluation 
    * AWS Organization policies
    * Principal permissions boundary    
* Policy elements
    * "NotPrincipal"
    * "NotResource"
    * "NotAction"
    * Placeholders like {"aws:username}"
    * Session tags
    * Conditions    
* S3 bucket
    * ACL policy
    * Public access settings
    * Cross-origin resource sharing settings
* Principal resolving from:
    * SAML providers
    * Web identity providers
    * OIDC providers
    * Canonical ID in S3 bucket policy 

   
